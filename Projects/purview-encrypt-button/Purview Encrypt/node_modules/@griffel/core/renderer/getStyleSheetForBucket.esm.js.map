{"version":3,"file":"getStyleSheetForBucket.esm.js","sources":["../../../../packages/core/src/renderer/getStyleSheetForBucket.ts"],"sourcesContent":["import { DATA_BUCKET_ATTR, DATA_PRIORITY_ATTR } from '../constants';\nimport type { GriffelRenderer, IsomorphicStyleSheet, StyleBucketName } from '../types';\nimport { createIsomorphicStyleSheet } from './createIsomorphicStyleSheet';\n\n/**\n * Ordered style buckets using their short pseudo name.\n *\n * @internal\n */\nexport const styleBucketOrdering: StyleBucketName[] = [\n  // reset styles\n  'r',\n  // catch-all\n  'd',\n  // link\n  'l',\n  // visited\n  'v',\n  // focus-within\n  'w',\n  // focus\n  'f',\n  // focus-visible\n  'i',\n  // hover\n  'h',\n  // active\n  'a',\n  // at rules for reset styles\n  's',\n  // keyframes\n  'k',\n  // at-rules\n  't',\n  // @media rules\n  'm',\n  // @container rules\n  'c',\n];\n\n// avoid repeatedly calling `indexOf` to determine order during new insertions\nconst styleBucketOrderingMap = styleBucketOrdering.reduce((acc, cur, j) => {\n  acc[cur as StyleBucketName] = j;\n  return acc;\n}, {} as Record<StyleBucketName, number>);\n\nexport function getStyleSheetKey(bucketName: StyleBucketName, media: string, priority: number | string): string {\n  return (bucketName === 'm' ? bucketName + media : bucketName) + priority;\n}\n\nexport function getStyleSheetKeyFromElement(styleEl: HTMLStyleElement): string {\n  const bucketName = styleEl.getAttribute(DATA_BUCKET_ATTR) as StyleBucketName;\n  const priority = styleEl.getAttribute(DATA_PRIORITY_ATTR) ?? '0';\n\n  return getStyleSheetKey(bucketName, styleEl.media, priority);\n}\n\n/**\n * Lazily adds a `<style>` bucket to the `<head>`. This will ensure that the style buckets are ordered.\n */\nexport function getStyleSheetForBucket(\n  bucketName: StyleBucketName,\n  targetDocument: Document | undefined,\n  insertionPoint: HTMLElement | null,\n  renderer: GriffelRenderer,\n  metadata: Record<string, unknown> = {},\n): IsomorphicStyleSheet {\n  const isMediaBucket = bucketName === 'm';\n\n  const media = (metadata['m'] as string | undefined) ?? '0';\n  const priority = (metadata['p'] as number | undefined) ?? 0;\n\n  const stylesheetKey = getStyleSheetKey(bucketName, media, priority);\n\n  if (!renderer.stylesheets[stylesheetKey]) {\n    const tag: HTMLStyleElement | undefined = targetDocument && targetDocument.createElement('style');\n    const stylesheet = createIsomorphicStyleSheet(tag, bucketName, priority, {\n      ...renderer.styleElementAttributes,\n      ...(isMediaBucket && { media }),\n    });\n\n    renderer.stylesheets[stylesheetKey] = stylesheet;\n\n    if (targetDocument?.head && tag) {\n      targetDocument.head.insertBefore(\n        tag,\n        findInsertionPoint(targetDocument, insertionPoint, bucketName, renderer, metadata),\n      );\n    }\n  }\n\n  return renderer.stylesheets[stylesheetKey]!;\n}\n\nfunction isSameInsertionKey(\n  element: HTMLStyleElement,\n  bucketName: StyleBucketName,\n  metadata: Record<string, unknown>,\n): boolean {\n  const targetKey = bucketName + ((metadata['m'] as string | undefined) ?? '');\n  const elementKey = element.getAttribute(DATA_BUCKET_ATTR) + (element.media ?? '');\n\n  return targetKey === elementKey;\n}\n\n/**\n * Finds an element before which the new bucket style element should be inserted following the bucket sort order.\n *\n * @param targetDocument - A document\n * @param insertionPoint - An element that will be used as an initial insertion point\n * @param targetBucket - The bucket that should be inserted to DOM\n * @param renderer - Griffel renderer\n * @param metadata - metadata for CSS rule\n * @returns - Smallest style element with greater sort order than the current bucket\n */\nfunction findInsertionPoint(\n  targetDocument: Document,\n  insertionPoint: HTMLElement | null,\n  targetBucket: StyleBucketName,\n  renderer: GriffelRenderer,\n  metadata: Record<string, unknown> = {},\n): Node | null {\n  const targetOrder = styleBucketOrderingMap[targetBucket];\n\n  const media = (metadata['m'] as string | undefined) ?? '';\n  const priority = (metadata['p'] as number | undefined) ?? 0;\n\n  // Similar to javascript sort comparators where\n  // a positive value is increasing sort order\n  // a negative value is decreasing sort order\n  let comparer: (el: HTMLStyleElement) => number = el =>\n    targetOrder - styleBucketOrderingMap[el.getAttribute(DATA_BUCKET_ATTR) as StyleBucketName];\n  let styleElements = targetDocument.head.querySelectorAll<HTMLStyleElement>(`[${DATA_BUCKET_ATTR}]`);\n\n  if (targetBucket === 'm') {\n    const mediaElements = targetDocument.head.querySelectorAll<HTMLStyleElement>(\n      `[${DATA_BUCKET_ATTR}=\"${targetBucket}\"]`,\n    );\n\n    // only reduce the scope of the search and change comparer\n    // if there are other media buckets already on the page\n    if (mediaElements.length) {\n      styleElements = mediaElements;\n      comparer = (el: HTMLStyleElement) => renderer.compareMediaQueries(media, el.media);\n    }\n  }\n\n  const comparerWithPriority: (el: HTMLStyleElement) => number = el => {\n    if (isSameInsertionKey(el, targetBucket, metadata)) {\n      return priority - Number(el.getAttribute('data-priority'));\n    }\n\n    return comparer(el);\n  };\n\n  const length = styleElements.length;\n  let index = length - 1;\n\n  while (index >= 0) {\n    const styleElement = styleElements.item(index);\n\n    if (comparerWithPriority(styleElement) > 0) {\n      return styleElement.nextSibling;\n    }\n\n    index--;\n  }\n\n  if (length > 0) {\n    return styleElements.item(0);\n  }\n\n  return insertionPoint ? insertionPoint.nextSibling : null;\n}\n"],"names":["styleBucketOrdering","styleBucketOrderingMap","reduce","acc","cur","j","getStyleSheetKey","bucketName","media","priority","getStyleSheetKeyFromElement","styleEl","getAttribute","DATA_BUCKET_ATTR","_a","DATA_PRIORITY_ATTR","getStyleSheetForBucket","targetDocument","insertionPoint","renderer","metadata","isMediaBucket","_b","stylesheetKey","stylesheets","tag","createElement","stylesheet","createIsomorphicStyleSheet","Object","assign","styleElementAttributes","head","insertBefore","findInsertionPoint","isSameInsertionKey","element","targetKey","elementKey","targetBucket","targetOrder","comparer","el","styleElements","querySelectorAll","mediaElements","length","compareMediaQueries","comparerWithPriority","Number","index","styleElement","item","nextSibling"],"mappings":"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"}